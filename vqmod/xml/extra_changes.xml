<modification>
    <id>Extra Changes - SOUK</id>
    <version>2.0.0</version>
    <vqmver>2.3.0</vqmver>
    <update>0.0.1</update>
    <author>Rohit Batra</author>

    <!-- Add a new Filter on Product List page for ADMIN -->

    <file name="admin/controller/catalog/product.php">
        <operation>
            <search position="before"><![CDATA[
            $pagination = new Pagination();
            ]]></search>
            <add><![CDATA[
                $data['entry_seller'] = $this->language->get('entry_seller');
                // Get Seller List
                $this->load->model('user/user');
                $data['sellers'] = $this->model_user_user->getSellers();
                $data['is_seller'] = false;
                if($this->user->isSeller())
                {
                    $data['is_seller'] = true;
                }
            ]]></add>
        </operation>
        <operation>
            <search position="after"><![CDATA[
                $data['filter_image'] = $filter_image;
            ]]></search>
            <add><![CDATA[
                if (isset($this->request->get['filter_seller'])) {
                    $filter_seller = $this->request->get['filter_seller'];
                } else {
                    $filter_seller = null;
                }

                $data['filter_seller'] = $filter_seller;
            ]]></add>
        </operation>

    </file>

    <file name="admin/model/user/user.php">
        <operation>
            <search position="before"><![CDATA[
                public function getTotalUsers() {
            ]]></search>
            <add><![CDATA[
                public function getSellers() {

                    $query = $this->db->query("SELECT u.user_id, u.username, u.firstname, u.lastname, u.email, u.status, ug.name as user_group_name FROM `" . DB_PREFIX . "user` AS u LEFT OUTER JOIN `" . DB_PREFIX . "user_group` ug ON (ug.user_group_id = u.user_group_id) WHERE ug.user_group_id <> '1' AND ug.user_group_id <> '2'  ");

                    return $query->rows;
                }
            ]]></add>
        </operation>
    </file>
    <!-- Add a new Filter on Product List page for ADMIN ENDS-->

    <!-- Show Seller Username on Sales Order Info Page per product ADMIN -->
    <file name="admin/view/template/sale/order_info.tpl">
        <operation>
            <search position="after"><![CDATA[
            <td class="text-left"><a href="<?php echo $product['href']; ?>"><?php echo $product['name']; ?></a>
            ]]></search>
            <add><![CDATA[
            <?php if(!$is_seller) { if(!empty($product['seller_username'])) { ?>  <small>  -||-  <a href="<?php echo $product['seller_href']; ?>"><?php echo $product['seller_username']; ?></a></small>  <?php } } ?>
            ]]></add>
        </operation>
    </file>

    <file name="admin/model/sale/order.php">
        <operation>
            <search position="before"><![CDATA[
            public function getTotalEmailsByProductsOrdered($products) {
            ]]></search>
            <add><![CDATA[
            public function getSellerDetails($data) {

                $sql = "SELECT u.{$data['searchFor']} FROM `" . DB_PREFIX . "user` as u LEFT OUTER JOIN `" . DB_PREFIX . "product` p ON (p.seller_id = u.user_id) WHERE p.product_id = '" . (int)$data['product_id'] . "'";

                $query = $this->db->query($sql);

                if($this->db->countAffected() > 0)
                {
                    return ($query->row[$data['searchFor']]);
                } else {
                    return 0;
                }
            }
            ]]></add>
        </operation>
    </file>

    <file name="admin/controller/sale/order.php">
        <operation>
            <search position="before"><![CDATA[
            'href'     		   => $this->url->link('catalog/product/edit', 'token=' . $this->session->data['token'] . '&product_id=' . $product['product_id'], true)
            ]]></search>
            <add><![CDATA[
            'seller_username' => $this->model_sale_order->getSellerDetails(array('product_id' => $product['product_id'], 'searchFor' => 'username')),
            'seller_href' => $this->url->link('user/user/edit', 'token=' . $this->session->data['token'] . '&user_id=' . $this->model_sale_order->getSellerDetails(array('product_id' => $product['product_id'], 'searchFor' => 'user_id')), true),
            ]]></add>
        </operation>
    </file>
    <!-- Show Seller Username on Sales Order Info Page per product ADMIN ENDS-->

    <!-- Show Drop-down on Header for SELLER -->
    <file name="catalog/view/theme/so-topdeal/template/header/header2.tpl">
      <operation error="log">
        <search position="before"><![CDATA[
            <li class="login" >
          ]]></search>
        <add><![CDATA[
          <?php if (!$logged) { ?>
            <li class="account" id="seller_drop">
              <a href="javascript:void(1);" class="btn-xs dropdown-toggle" data-toggle="dropdown">
                <span><?php echo 'Seller(s)'; ?></span>
                <span class="fa fa-angle-down"></span>
              </a>
              <ul class="dropdown-menu ">
                <li><a href="<?php echo $seller_login; ?>"><?php echo $text_login; ?></a></li>
                <li><a href="<?php echo $seller_register; ?>"><?php echo $text_register; ?></a></li>
              </ul>
            </li>
          <?php } ?>
          ]]></add>
      </operation>
    </file>


    <file name="catalog/controller/common/header.php">
      <operation>
        <search position="before"><![CDATA[
            $data['login'] = $this->url->link('account/login', '', true);
          ]]></search>
        <add><![CDATA[
          $data['seller_login'] = $this->url->link('seller/login', '', true);
          $data['seller_register'] = $this->url->link('seller/register', '', true);
          ]]></add>
      </operation>
    </file>

    <!-- Show Drop-down on Header for SELLER ENDS-->

    <!-- Set a Default Reply-To address in mail function itself -->
    <file name="system/library/mail.php">

      <operation>
        <search position="after"><![CDATA[
            protected $reply_to;
          ]]></search>
        <add><![CDATA[
            public $default_reply_to = "support@sezplus.com";
          ]]></add>
      </operation>

      <operation>
        <search position="replace"><![CDATA[
            $header .= 'Reply-To: =?UTF-8?B?' . base64_encode($this->sender) . '?= <' . $this->from . '>' . PHP_EOL;
          ]]></search>
        <add><![CDATA[
            $header .= 'Reply-To: =?UTF-8?B?' . base64_encode($this->default_reply_to) . '?= <' . $this->from . '>' . PHP_EOL;
          ]]></add>
      </operation>

    </file>

    <!-- Remove Floating Widget on Home Page -->
    <file name="catalog/view/theme/so-topdeal/template/common/home.tpl">
      <operation>
        <search position="replace"><![CDATA[
            <div class="custom-scoll hidden-sm hidden-md hidden-xs">
          ]]></search>
        <add><![CDATA[
            <div class="custom-scoll hidden hidden-sm hidden-md hidden-xs">
          ]]></add>
      </operation>
    </file>

    <!-- Only List Admin/Mods in ADMIN User List -->
    <file name="admin/controller/user/user.php">

      <operation>
        <search position="after"><![CDATA[
            'start' => ($page - 1) * $this->config->get('config_limit_admin'),
          ]]></search>
        <add><![CDATA[
            'user_type' => array('administrator', 'moderator'),
          ]]></add>
      </operation>

      <operation>
        <search position="after"><![CDATA[
            'status'     => ($result['status'] ? $this->language->get('text_enabled') : $this->language->get('text_disabled')),
          ]]></search>
        <add><![CDATA[
            'user_group' => $result['user_group'],
          ]]></add>
      </operation>

      <operation>
        <search position="after"><![CDATA[
            $data['column_action'] = $this->language->get('column_action');
          ]]></search>
        <add><![CDATA[
            $data['column_user_group'] = $this->language->get('column_user_group');
          ]]></add>
      </operation>

      <operation>
        <search position="replace"><![CDATA[
            $user_total = $this->model_user_user->getTotalUsers();
          ]]></search>
        <add><![CDATA[
            $user_total = $this->model_user_user->getTotalUsers($filter_data);
          ]]></add>
      </operation>

    </file>

    <file name="admin/language/en-gb/user/user.php">

      <operation>
        <search position="after"><![CDATA[
            $_['column_action']         = 'Action';
          ]]></search>
        <add><![CDATA[
            $_['column_user_group']         = 'User Group';
          ]]></add>
      </operation>

    </file>

    <file name="admin/view/template/user/user_list.tpl">

      <operation>
        <search position="after" offset="1"><![CDATA[
            <a href="<?php echo $sort_status; ?>"><?php echo $column_status; ?></a>
          ]]></search>
        <add><![CDATA[
            <td class="text-left"><?php echo $column_user_group; ?></td>
          ]]></add>
      </operation>


      <operation>
        <search position="after"><![CDATA[
            <td class="text-left"><?php echo $user['status']; ?></td>
          ]]></search>
        <add><![CDATA[
            <td class="text-left"><?php echo $user['user_group']; ?></td>
          ]]></add>
      </operation>

    </file>

    <file name="admin/model/user/user.php">

      <operation>
        <search position="before"><![CDATA[
            if (isset($data['sort']) && in_array($data['sort'], $sort_data)) {
          ]]></search>
        <add><![CDATA[
            if (isset($data['user_type']) && !empty($data['user_type'])) {
              $sql .= " WHERE ";
              foreach ($data['user_type'] as $ugn)
              {
                $sql .= "  LOWER(ug.name) LIKE '{$ugn}' OR ";
              }
              $sql = substr($sql, 0, -3);
        		}
        ]]></add>
      </operation>

      <operation>
        <search position="replace"><![CDATA[
          public function getTotalUsers() {
        ]]></search>
        <add><![CDATA[
          public function getTotalUsersOLD() {
        ]]></add>
      </operation>

      <operation>
        <search position="before"><![CDATA[
          public function getTotalUsersByGroupId($user_group_id) {
        ]]></search>
        <add><![CDATA[
          public function getTotalUsers($data)
          {
            if (isset($data['user_type']) && !empty($data['user_type']))
            {
                $addSQL = "LEFT OUTER JOIN `" . DB_PREFIX . "user_group`  ug ON (ug.user_group_id = u.user_group_id) WHERE ";

                foreach ($data['user_type'] as $ugn)
                {
                  $addSQL .= "  LOWER(ug.name) LIKE '{$ugn}' OR ";
                }

                $addSQL = substr($addSQL, 0, -3);

            } else {
                $addSQL = "";
            }

            $query = $this->db->query("SELECT COUNT(u.user_id) AS total FROM `" . DB_PREFIX . "user` AS u {$addSQL} ");
            return $query->row['total'];
          }
        ]]></add>
      </operation>

      <operation>
        <search position="replace"><![CDATA[
          $sql = "SELECT * FROM `" . DB_PREFIX . "user`";
        ]]></search>
        <add><![CDATA[
          $sql = "SELECT u.*, ug.name as user_group FROM `" . DB_PREFIX . "user` AS u LEFT JOIN `" . DB_PREFIX . "user_group`  ug ON (ug.user_group_id = u.user_group_id)";
        ]]></add>
      </operation>

    </file>

    <!-- Add a new menu-item `Seller` ADMIN -->
    <file name="admin/controller/common/column_left.php">

      <operation>
        <search position="before"><![CDATA[
          // Localisation
        ]]></search>
        <add><![CDATA[
          if ($this->user->hasPermission('access', 'seller/seller')) {
      				$system[] = array(
              'name'	   => $this->language->get('text_sellers'),
              'href'     => $this->url->link('seller/seller', 'token=' . $this->session->data['token'], true),
              'children' => array()
      				);
          }
        ]]></add>
      </operation>

    </file>

    <file name="admin/language/en-gb/common/column_left.php">

      <operation>
        <search position="after"><![CDATA[
          $_['text_users']                     = 'Users';
        ]]></search>
        <add><![CDATA[
          $_['text_sellers']                     = 'Sellers';
        ]]></add>
      </operation>

    </file>

</modification>
