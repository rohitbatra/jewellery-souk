<modification>
    <id>Product Module Changes - SOUK</id>
    <version>2.0.0</version>
    <vqmver>2.3.0</vqmver>
    <update>0.0.1</update>
    <author>Rohit Batra</author>

    <file name="admin/view/template/extension/soconfig/mproduct_form.tpl">

      <!-- Hide NEW options of Template -->
      <operation>
          <search position="replace" index="1,2,3,4"><![CDATA[
              <div class="form-group">
          ]]></search>
          <add><![CDATA[
              <div class="form-group hidden">
          ]]></add>
      </operation>

      <operation>
          <search position="replace" offset="3"><![CDATA[
              <li><a href="#tab-option" data-toggle="tab"><?php echo $tab_option; ?></a></li>
          ]]></search>
          <add><![CDATA[
          ]]></add>
      </operation>

      <operation>
          <search position="replace"><![CDATA[
              <li><a href="#tab-attribute" data-toggle="tab"><?php echo $tab_attribute; ?></a></li>
          ]]></search>
          <add><![CDATA[
          ]]></add>
      </operation>

      <operation>
          <search position="after"><![CDATA[
              <li><a href="#tab-image" data-toggle="tab"><?php echo $tab_image; ?></a></li>
          ]]></search>
          <add><![CDATA[
            <li><a href="#tab-attribute" data-toggle="tab"><?php echo $tab_attribute; ?></a></li>
          ]]></add>
      </operation>


      <operation>
          <search position="replace"><![CDATA[
              <label class="col-sm-2 control-label" for="input-image"><?php echo $entry_image; ?></label>
          ]]></search>
          <add><![CDATA[
              <label class="col-sm-2 control-label" for="input-image"><?php echo $entry_thumbnail_image; ?></label>
          ]]></add>
      </operation>

      <operation>
          <search position="replace" offset="1"><![CDATA[
              <li><a href="#tab-reward" data-toggle="tab"><?php echo $tab_reward; ?></a></li>
          ]]></search>
          <add><![CDATA[
          ]]></add>
      </operation>

      <operation>
          <search position="replace" offset="-1"><![CDATA[
              <label class="col-sm-2 control-label"><?php echo $entry_store; ?></label>
          ]]></search>
          <add><![CDATA[
            <div class="form-group hidden">
              <label class="col-sm-2 control-label"><?php echo $entry_store; ?></label>
          ]]></add>
      </operation>

      <operation>
          <search position="before"><![CDATA[
              <?php echo $footer; ?>
          ]]></search>
          <add><![CDATA[
              <script type="text/javascript">
                $(window).load(function()
                {
                    // array of fields to not show
                    var fields = ['input-model','input-sku','input-upc','input-ean','input-jan','input-isbn','input-mpn','input-tax-class','input-subtract','input-stock-status','input-sort-order','input-meta-description1','input-meta-keyword1','input-tag1','input-manufacturer','input-download'];
                    $.each(fields, function (index, value) {
                        $('#'+value).parents('div.form-group').hide();
                    });

                    // No Id field & Default Model Value
                    $('input:radio[name="shipping"]').parents('div.form-group').hide();
                    $('input:radio[name="shipping"][value="0"]').prop('checked','checked');
                    $('#input-model').val("<?php echo time(); ?>");
                    $('#input-quantity').val("1000000");

                    $('#input-name1').on('change', function() {
                        $('#input-meta-title1').val($(this).val());
                        $('#input-model').val($(this).val());
                    });
                });
              </script>
          ]]></add>
      </operation>

      <!-- Additional Fields for Product Module -->
      <operation>
          <search position="before"><![CDATA[
              <label class="col-sm-2 control-label" for="input-weight"><?php echo $entry_weight; ?></label>
          ]]></search>
          <add><![CDATA[
              <?php if(!$is_seller) { ?>
                <label class="col-sm-2 control-label" for="input-seller"><?php echo "Seller"; ?></label>
                <div class="col-sm-10">
                  <input type="text" value="<?php echo $seller; ?>" class="form-control" disabled="disabled" />
                </div>
               </div>
               <div class="form-group">
              <?php } ?>
          ]]></add>
      </operation>

      <!-- Making Price/Category Compulsory -->

      <operation>
          <search position="replace" offset="10"><![CDATA[
            <label class="col-sm-2 control-label" for="input-category"><span data-toggle="tooltip" title="<?php echo $help_category; ?>"><?php echo $entry_category; ?></span></label>
          ]]></search>
          <add><![CDATA[
              <label class="col-sm-2 control-label" for="input-category"><?php echo $entry_category; ?></label>
              <?php if($is_seller) { ?>
                <div class="col-sm-10">
                  <select name="product_category" id="input-category" class="form-control">
                    <option value="*">Select Category</option>
                      <?php foreach($categories as $category) { ?>
                          <?php if($category['category_id'] == $product['category_id']) { ?>
                            <option selected value="<?php echo $category['category_id'];?>"><?php echo $category['name'];?></option>
                          <?php } else { ?>
                            <option value="<?php echo $category['category_id'];?>"><?php echo $category['name'];?></option>
                          <?php } ?>
                      <?php } ?>
                  </select>
                </div>
              <?php } else { ?>
                <div class="col-sm-10">
                  <input type="text" name="category" value="" placeholder="<?php echo $entry_category; ?>" id="input-category" class="form-control" />
                  <div id="product-category" class="well well-sm" style="height: 150px; overflow: auto;">
                    <?php foreach ($product_categories as $product_category) { ?>
                    <div id="product-category<?php echo $product_category['category_id']; ?>"><i class="fa fa-minus-circle"></i> <?php echo $product_category['name']; ?>
                      <input type="hidden" name="product_category[]" value="<?php echo $product_category['category_id']; ?>" />
                    </div>
                    <?php } ?>
                  </div>
                </div>
              <?php } ?>

              <?php if ($error_product_category) { ?>
                <div class="text-danger"><?php echo $error_product_category; ?></div>
              <?php } ?>

          ]]></add>
      </operation>

      <operation>
          <search position="replace" offset="-1"><![CDATA[
          <label class="col-sm-2 control-label" for="input-price"><?php echo $entry_price; ?></label>
          ]]></search>
          <add><![CDATA[
          <div class="form-group required">
              <label class="col-sm-2 control-label" for="input-price"><?php echo $entry_price; ?></label>
          ]]></add>
      </operation>

      <operation>
          <search position="replace"><![CDATA[
                <input type="text" name="price" value="<?php echo $price; ?>" placeholder="<?php echo $entry_price; ?>" id="input-price" class="form-control" />
          ]]></search>
          <add><![CDATA[
              <input type="text" name="price" value="<?php echo $price; ?>" placeholder="<?php echo $entry_price; ?>" id="input-price" class="form-control" />
              <?php if ($error_price) { ?>
                  <div class="text-danger"><?php echo $error_price; ?></div>
              <?php } ?>
          ]]></add>
      </operation>
      <!-- Making Price/Category Compulsory ENDS-->

    </file>

    <file name="admin/language/en-gb/catalog/product.php">
      <!-- Making Category & Price Compulsory -->
        <operation>
            <search position="before"><![CDATA[
              $_['error_model']            = 'Product Model must be greater than 1 and less than 64 characters!';
            ]]></search>
            <add><![CDATA[
               $_['error_product_category']            = 'Please select one category for your Product!';
               $_['error_price']            = 'Please enter Price for your Product!';
            ]]></add>
        </operation>
        <!-- Making Category & Price Compulsory ENDS-->
    </file>

    <file name="admin/language/en-gb/soconfig/mproduct.php">
      <!-- Making Category & Price Compulsory -->
        <operation>
            <search position="before"><![CDATA[
              $_['error_model']            = 'Product Model must be greater than 1 and less than 64 characters!';
            ]]></search>
            <add><![CDATA[
               $_['error_product_category']            = 'Please select one category for your Product!';
               $_['error_price']            = 'Please enter Price for your Product!';
            ]]></add>
        </operation>

        <operation>
            <search position="before"><![CDATA[
                $_['entry_image']            = 'Image';
            ]]></search>
            <add><![CDATA[
               $_['entry_thumbnail_image']            = 'Thumbnail Image';
            ]]></add>
        </operation>
        <!-- Making Category & Price Compulsory ENDS-->
    </file>

  <file name="admin/controller/catalog/mproduct.php">

    <operation>
        <search position="before"><![CDATA[
        $data['entry_sku'] = $this->language->get('entry_sku');
        ]]></search>
        <add><![CDATA[
        $data['error_product_category'] = $this->language->get('error_product_category');
        $data['error_price'] = $this->language->get('error_price');
        ]]></add>
    </operation>

    <operation>
        <search position="after"><![CDATA[
        $data['entry_image'] = $this->language->get('entry_image');
        ]]></search>
        <add><![CDATA[
        $data['entry_thumbnail_image'] = $this->language->get('entry_thumbnail_image');
        ]]></add>
    </operation>

    <operation>
      <search position="before"><![CDATA[
          if (isset($this->request->post['height'])) {
      ]]></search>
      <add><![CDATA[

          // Seller
          if (isset($this->request->post['created_using']))
          {
              $data['seller'] = $this->request->post['seller'];
          } elseif (!empty($product_info) && !empty($product_info['seller_id']))
          {
              $data['seller'] = $this->model_soconfig_mproduct->getSellerName($product_info['seller_id']);
          } else {
              $data['seller'] = 'Me';
          }

          $data['is_seller'] = false;
          if($this->user->isSeller())
          {
              $data['is_seller'] = true;
          }

          // Fetch Categories if Seller
          if($data['is_seller'])
          {
              $this->load->model('catalog/category');
              $data['categories'] = $this->model_catalog_category->getCategoriesForUserGroup($this->user->getGroupId());
          }

      ]]></add>
  </operation>

  <!-- Making Category Compulsory -->

  <operation>
      <search position="before"><![CDATA[
          if ((utf8_strlen($this->request->post['model']) < 1) || (utf8_strlen($this->request->post['model']) > 64)) {
      ]]></search>
      <add><![CDATA[
            if(!isset($this->request->post['product_category']))
            {
                $this->error['product_category'] = $this->language->get('error_product_category');

            }else{

              if(!empty($this->request->post['product_category']))
              {
                  foreach($this->request->post['product_category'] as $category_id)
                  {
                      if (empty($category_id)) {
                          $this->error['product_category'] = $this->language->get('error_product_category');
                      }
                  }
              }
           }

            if(!isset($this->request->post['price']) || (utf8_strlen($this->request->post['price']) < 1))
            {
                $this->error['price'] = $this->language->get('error_price');

            }

      ]]></add>
  </operation>
  <operation>
      <search position="before"><![CDATA[
          if (isset($this->error['name'])) {
      ]]></search>
      <add><![CDATA[
      if (isset($this->error['product_category'])) {
          $data['error_product_category'] = $this->error['product_category'];
      } else {
          $data['error_product_category'] = '';
      }
      if (isset($this->error['price'])) {
          $data['error_price'] = $this->error['price'];
      } else {
          $data['error_price'] = '';
      }
      ]]></add>
  </operation>
  <!-- Making Category Compulsory ENDS-->

</file>

<file name="admin/model/soconfig/mproduct.php">

  <operation>
      <search position="replace"><![CDATA[
          sku = '" . $this->db->escape($data['sku']) . "'
      ]]></search>
      <add><![CDATA[
          sku = '" . $this->db->escape($data['sku']) . "' , tone_count = '" . $this->db->escape($data['tone_count']) . "' , silver_weight = '" . $this->db->escape($data['silver_weight']) . "' , gold_weight = '" . $this->db->escape($data['gold_weight']) . "' , diamond_weight = '" . $this->db->escape($data['diamond_weight']) . "' , parts_count = '" . $this->db->escape($data['parts_count']) . "' , created_using = '" . $this->db->escape($data['created_using']) . "'
      ]]></add>
  </operation>

  <operation>
      <search position="after"><![CDATA[
          $product_id = $this->db->getLastId();
      ]]></search>
      <add><![CDATA[
          if($this->user->isSeller())
          {
              $this->db->query("UPDATE " . DB_PREFIX . "product  SET seller_id = '".$this->user->getId()."' WHERE product_id = '{$product_id}' ");
          }
      ]]></add>
  </operation>

  <operation>
      <search position="after"><![CDATA[
          public function editProduct($product_id, $data) {
      ]]></search>
      <add><![CDATA[
          if($this->user->isSeller())
          {
              $this->db->query("UPDATE " . DB_PREFIX . "product  SET seller_id = '".$this->user->getId()."' WHERE product_id = '{$product_id}' ");
          }
      ]]></add>
  </operation>

  <operation>
      <search position="before"><![CDATA[
          public function getProduct($product_id) {
      ]]></search>
      <add><![CDATA[
          public function getSellerName($user_id) {

              $query = $this->db->query("SELECT u.username FROM `user` AS u WHERE u.user_id = '".(int)$user_id."' ");

              return $query->row['username'];
          }
      ]]></add>
  </operation>

</file>

<file name="admin/model/catalog/category.php">

  <operation>
      <search position="before"><![CDATA[
          public function getTotalCategories() {
      ]]></search>
      <add><![CDATA[
          public function getCategoriesForUserGroup($user_group_id) {

            $sql = "SELECT cp.category_id AS category_id, GROUP_CONCAT(cd1.name ORDER BY cp.level SEPARATOR '&nbsp;&nbsp;&gt;&nbsp;&nbsp;') AS name, c1.parent_id, c1.sort_order
                    FROM " . DB_PREFIX . "category_path cp
                    LEFT JOIN " . DB_PREFIX . "category c1
                    ON (cp.category_id = c1.category_id)
                    LEFT JOIN " . DB_PREFIX . "category c2
                    ON (cp.path_id = c2.category_id)
                    LEFT JOIN " . DB_PREFIX . "category_description cd1
                    ON (cp.path_id = cd1.category_id)
                    LEFT JOIN " . DB_PREFIX . "category_description cd2
                    ON (cp.category_id = cd2.category_id)
                    LEFT JOIN " . DB_PREFIX . "category_to_user_group ctug
                    ON (ctug.category_id = cp.category_id)
                    WHERE cd1.language_id = '" . (int)$this->config->get('config_language_id') . "'
                    AND ctug.user_group_id = '" . (int)$user_group_id . "'
                    AND cd2.language_id = '" . (int)$this->config->get('config_language_id') . "'";

            $sql .= " GROUP BY cp.category_id";

            $query = $this->db->query($sql);

            return $query->rows;
          }
      ]]></add>
  </operation>

</file>

</modification>
